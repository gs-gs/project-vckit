<!DOCTYPE html>
<html>
  <head>
    <title>iFrame Rendering</title>
  </head>
  <script src="https://unpkg.com/penpal@5.3.0/dist/penpal.min.js"></script>
  <body>
    <div>
      <button onclick="renderDocument()">
        Render OA document
      </button>
      <button onclick="renderSVGDocument()">
        Render SVG document
      </button>
    </div>
    <div id="template-selector"></div>
    <iframe id="iframe" src="http://localhost:3000" style="width: 100%; border: 0px; overflow: hidden;"></iframe>
  </body>

  <script type="text/javascript">
    const iframe = document.getElementById("iframe");
    const templateSelector = document.getElementById("template-selector");
    let frame;

    const oaDocument = {
      name: "John Doe",
      institute: "Institute of John Doe",
      issuers: [
        {
          name: "institute of blockchain"
        }
      ],
      $template: {
        name: "custom",
        type: "EMBEDDED_RENDERER",
        url: "http://localhost:3000"
      },
      foo: {
        title: "Bar is awesome"
      }
    };

    const SVGDocument = {
      issuers: [
        {
          name: "institute of blockchain"
        }
      ],
      $template: {
        name: "svgTemplate",
        type: "EMBEDDED_RENDERER",
        url: "http://localhost:3000"
      },
      svgTemplateFile: "http://localhost:3000/src/templates/samples/purchaseOrderForm.svg",
      svgTemplate: "purchaseOrderForm",
      type: ["PurchaseOrder"],
      purchaseOrderNo: "fe71665a-e7b3-49ba-ac89-82fc2bf1e877",
      orderDate: "2021-02-21",
      buyer: {
        type: ["Organization"],
        location: {
          type: ["Place"],
          address: {
            type: ["PostalAddress"],
            name: "Generic Motors of America",
            streetAddress: "12 Generic Motors Dr",
            addressLocality: "Detroit",
            addressRegion: "Michigain",
            postalCode: "48232-5170",
            addressCountry: "USA"
          }
        }
      },
      seller: {
        type: ["Organization"],
        location: {
          type: ["Place"],
          address: {
            type: ["PostalAddress"],
            name: "Aishi Metal Shinzo Co., Ltd.",
            streetAddress: "1651, Shimonakano, Yoshida",
            addressLocality: "Tsubame-shi",
            addressRegion: "Niigata-ken",
            postalCode: "959-0215",
            addressCountry: "Japan"
          }
        }
      },
      items: [
        {
          type: ["TradeLineItem"],
          product: {
            type: ["Product"],
            id: "https://aishi-metal-shinzo.example.com/products/UNS-S30400-chromium-nickel-stainless-steel-roll",
            description: "UNS S30400 chromium-nickel stainless steel roll",
            weight: {
              type: ["QuantitativeValue"],
              unitCode: "lbs",
              value: "16500"
            }
          },
          itemCount: 5,
          grossWeight: {
            type: ["QuantitativeValue"],
            value: "82500",
            unitCode: "lbs"
          },
          lineItemTotalPrice: {
            type: ["PriceSpecification"],
            price: 5200,
            priceCurrency: "USD"
          }
        },
        {
          type: ["TradeLineItem"],
          product: {
            type: ["Product"],
            id:
              "https://aishi-metal-shinzo.example.com/products/Galvannealed-ASTM-A-653-zinc-iron-alloy-coated-steel-sheet",
            description: "Galvannealed ASTM A-653 zinc-iron alloy-coated steel sheet",
            weight: {
              type: ["QuantitativeValue"],
              value: "12680",
              unitCode: "lbs"
            }
          },
          itemCount: 20,
          grossWeight: {
            type: ["QuantitativeValue"],
            value: "253600",
            unitCode: "lbs"
          },
          lineItemTotalPrice: {
            type: ["PriceSpecification"],
            price: 4400,
            priceCurrency: "USD"
          }
        }
      ],
      totalWeight: {
        type: ["QuantitativeValue"],
        value: "336100",
        unitCode: "lbs"
      },
      totalOrderAmount: {
        type: ["PriceSpecification"],
        price: 9600,
        priceCurrency: "USD"
      }
    };

    const dispatch = action => {
      const { type, payload } = action;
      if (type === "UPDATE_HEIGHT") {
        iframe.height = payload;
      }
    };

    const connection = Penpal.connectToChild({
      iframe,
      methods: {
        dispatch
      }
    });

    const renderDocumentAction = {
      type: "RENDER_DOCUMENT",
      payload: {
        document: oaDocument
      }
    };

    const renderSVGDocumentAction = {
      type: "RENDER_DOCUMENT",
      payload: {
        document: SVGDocument
      }
    };

    const getTemplatesAction = {
      type: "GET_TEMPLATES",
      payload: oaDocument
    };

    const getSVGTemplatesAction = {
      type: "GET_TEMPLATES",
      payload: SVGDocument
    };

    const renderDocument = () => {
      if (!frame) console.warn("frame connection not established.");
      frame.dispatch(renderDocumentAction);
    };

    const renderSVGDocument = () => {
      if (!frame) console.warn("frame connection not established.");
      frame.dispatch(renderSVGDocumentAction);
    };

    const buildTemplateButtons = templates => {
      templates.forEach((tab, index) => {
        const btn = document.createElement("button");
        btn.innerHTML = tab.label;
        btn.id = `selector-${tab.id}`;
        btn.onclick = () => {
          frame.dispatch({
            type: "SELECT_TEMPLATE",
            payload: tab.id
          });
        };
        templateSelector.appendChild(btn);
      });
    };

    const renderTemplateSelector = () => {
      if (!frame) console.warn("frame connection not established.");
      frame.dispatch(getTemplatesAction).then(templates => {
        buildTemplateButtons(templates);
      });

      frame.dispatch(getSVGTemplatesAction).then(templates => {
        buildTemplateButtons(templates);
      });
    };

    connection.promise.then(child => {
      frame = child;
      renderTemplateSelector();
    });
  </script>
</html>
